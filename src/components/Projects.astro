---
interface Project {
  id: string;
  title: string;
  description: string;
  technologies: string[];
  github_url?: string;
  live_url?: string;
  image_url: string;
  category?: string;
}

// Function to safely truncate description
const truncate = (str: string | undefined, n: number): string => {
  if (!str) return '';
  return str.length > n ? str.substring(0, n) + '...' : str;
};
---

<section id="projects" class="section bg-dark-800/95 relative overflow-hidden py-20">
  <div class="absolute inset-0 overflow-hidden opacity-10">
    <div class="absolute -top-1/2 -left-1/4 w-[800px] h-[800px] bg-primary-500/20 rounded-full filter blur-3xl"></div>
    <div class="absolute -bottom-1/4 -right-1/4 w-[600px] h-[600px] bg-primary-400/15 rounded-full filter blur-3xl"></div>
  </div>
  
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <div class="text-center mb-16" data-aos="fade-up">
      <span class="text-primary-400 font-mono text-sm tracking-wider">MY WORK</span>
      <h2 class="text-4xl md:text-5xl font-bold mt-3 mb-4 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
        Featured <span class="text-primary-400">Projects</span>
      </h2>
      <div class="w-20 h-1 bg-gradient-to-r from-primary-500 to-primary-300 mx-auto rounded-full"></div>
    </div>
    
    <!-- Projects Container -->
    <div id="projects-container" class="relative min-h-64">
      <!-- Loading State -->
      <div id="loading-state" class="flex flex-col items-center justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500 mb-4"></div>
        <p class="text-gray-400">Loading projects...</p>
      </div>
      
      <!-- Error State (hidden by default) -->
      <div id="error-state" class="hidden text-center py-12">
        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
        <p class="text-red-400 mb-4">Failed to load projects. Please try again later.</p>
        <button 
          id="retry-button" 
          class="btn btn-sm btn-outline-primary"
        >
          <i class="fas fa-sync-alt mr-2"></i> Retry
        </button>
      </div>
      
      <!-- Projects will be inserted here by JavaScript -->
    </div>
  </div>
  
  <!-- Client-side Script -->
  <script>
    // Project type definition - debe coincidir con los nombres de las columnas en la base de datos
    interface Project {
      id: string;
      title: string;
      description: string;
      technologies: string[];
      github_url?: string;
      live_url?: string;
      image_url: string;
      category?: string;
      created_at?: string;
      updated_at?: string;
    }

    // Helper function to truncate text
    function truncateText(str: string, n: number) {
      if (!str) return '';
      return str.length > n ? str.substring(0, n) + '...' : str;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const projectsContainer = document.getElementById('projects-container');
      const loadingState = document.getElementById('loading-state');
      const errorState = document.getElementById('error-state');
      const retryButton = document.getElementById('retry-button');
      
      async function loadProjects() {
        try {
          // Show loading state
          if (loadingState) loadingState.classList.remove('hidden');
          if (errorState) errorState.classList.add('hidden');
          
          // Test the test endpoint first
          console.log('Testing API connection...');
          const testResponse = await fetch('/api/test');
          console.log('Test endpoint status:', testResponse.status);
          
          if (!testResponse.ok) {
            throw new Error('Test endpoint failed');
          }
          
          // Fetch projects
          console.log('Fetching projects...');
          const projectsResponse = await fetch('/api/projects', {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
          });
          
          console.log('Projects response status:', projectsResponse.status);
          
          if (!projectsResponse.ok) {
            const errorText = await projectsResponse.text();
            console.error('Projects API error:', errorText);
            throw new Error('HTTP error! status: ' + projectsResponse.status);
          }
          
          const result = await projectsResponse.json();
          console.log('Projects API response:', result);
          
          // Clear container and hide loading state
          if (projectsContainer) {
            projectsContainer.innerHTML = '';
            
            // Asegurar que los proyectos estén ordenados por fecha de creación (más recientes primero)
            const projects = (result?.data || []).sort((a: Project, b: Project) => {
              // Si alguna fecha es nula o indefinida, la ponemos al final
              if (!a.created_at) return 1;
              if (!b.created_at) return -1;
              
              // Convertir las fechas a timestamps y comparar
              return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
            });
            
            console.log('Proyectos ordenados:', projects.map((p: Project) => ({
              title: p.title,
              created_at: p.created_at
            })));
            
            if (projects.length === 0) {
              projectsContainer.innerHTML = `
                <div class="text-center py-12">
                  <p class="text-gray-400">No projects found.</p>
                </div>
              `;
              return;
            }
            
            const projectsGrid = document.createElement('div');
            projectsGrid.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12';
            
            console.log('Proyectos cargados:', projects);
            
            projects.forEach((project: Project, index: number) => {
              console.log(`Procesando proyecto ${index + 1}/${projects.length}:`, project.title);
              console.log('Datos del proyecto:', {
                title: project.title,
                hasImageUrl: !!project.image_url,
                imageUrl: project.image_url
              });
              
              const projectElement = document.createElement('div');
              projectElement.className = 'group relative overflow-hidden rounded-2xl bg-dark-800/50 backdrop-blur-sm border border-dark-700/50 shadow-xl transition-all duration-300 hover:border-primary-400/30 hover:shadow-lg hover:shadow-primary-500/10 hover:-translate-y-1';
              projectElement.setAttribute('data-aos', 'fade-up');
              projectElement.setAttribute('data-aos-delay', String(index * 100));
              
              // Create project image section
              const imageSection = document.createElement('div');
              imageSection.className = 'relative overflow-hidden aspect-video';
              
              if (project.image_url && project.image_url.trim() !== '') {
                console.log(`[${project.title}] Procesando imagen:`, project.image_url);
                try {
                  // Crear la imagen de manera síncrona
                  const img = document.createElement('img');
                  let imageUrl = project.image_url;
                  
                  // Asegurarse de que la URL sea absoluta
                  if (imageUrl.startsWith('http')) {
                    // Si ya es una URL HTTP/HTTPS, asegurarse de que use HTTPS
                    imageUrl = imageUrl.replace('http://', 'https://');
                  } else if (!imageUrl.startsWith('/')) {
                    // Si es una ruta relativa, hacerla absoluta
                    imageUrl = `/${imageUrl}`;
                  }
                  
                  console.log('Cargando imagen:', imageUrl);
                  
                  // Configurar la imagen
                  img.src = imageUrl;
                  img.alt = project.title || 'Project image';
                  img.className = 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-105';
                  img.loading = 'lazy';
                  
                  // Forzar la visualización
                  img.style.display = 'block';
                  
                  // Manejar errores
                  img.onerror = function() {
                    console.error('Error al cargar la imagen:', imageUrl);
                    this.onerror = null;
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiB2aWV3Qm94PSIwIDAgNDAwIDMwMCIgZmlsbD0iIzFhMjEyOSI+PHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIzMDAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iI2ZmZiI+SW1hZ2Ugbm90IGZvdW5kPC90ZXh0Pjwvc3ZnPg==';
                  };
                  
                  // Agregar la imagen al contenedor
                  imageSection.appendChild(img);
                  console.log('Imagen agregada al DOM');
                } catch (error) {
                  console.error('Error al crear la imagen:', error);
                }
              } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'w-full h-full bg-dark-700 flex items-center justify-center';
                const icon = document.createElement('i');
                icon.className = 'fas fa-image text-4xl text-gray-600';
                placeholder.appendChild(icon);
                imageSection.appendChild(placeholder);
              }
              
              // Add gradient overlay
              const gradientOverlay = document.createElement('div');
              gradientOverlay.className = 'absolute inset-0 bg-gradient-to-t from-dark-900/90 via-dark-900/20 to-transparent group-hover:from-dark-900/80 group-hover:via-dark-900/10 transition-all duration-500';
              imageSection.appendChild(gradientOverlay);
              
              // Add title and category overlay
              const titleOverlay = document.createElement('div');
              titleOverlay.className = 'absolute bottom-0 left-0 right-0 p-6';
              
              const title = document.createElement('h3');
              title.className = 'text-2xl font-bold text-white';
              title.textContent = project.title;
              
              const category = document.createElement('p');
              category.className = 'text-sm text-gray-300 mt-1';
              category.textContent = project.category || 'Web Development';
              
              titleOverlay.appendChild(title);
              titleOverlay.appendChild(category);
              imageSection.appendChild(titleOverlay);
              projectElement.appendChild(imageSection);
              
              // Create project content section
              const contentSection = document.createElement('div');
              contentSection.className = 'p-6';
              
              // Add technologies
              const techContainer = document.createElement('div');
              techContainer.className = 'flex flex-wrap gap-2 mb-4';
              
              if (project.technologies && project.technologies.length > 0) {
                project.technologies.forEach((tech: string) => {
                  const techSpan = document.createElement('span');
                  techSpan.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-dark-700/80 text-gray-200 border border-dark-600/50 group-hover:border-primary-400/30 transition-all duration-300';
                  techSpan.textContent = tech;
                  techContainer.appendChild(techSpan);
                });
              }
              
              contentSection.appendChild(techContainer);
              
              // Add description
              if (project.description) {
                const description = document.createElement('p');
                description.className = 'text-gray-300 mb-6 leading-relaxed';
                description.textContent = truncateText(project.description, 150);
                contentSection.appendChild(description);
              }
              
              // Add action buttons
              const buttonsContainer = document.createElement('div');
              buttonsContainer.className = 'flex flex-wrap gap-3';
              
              // GitHub button
              if (project.github_url) {
                const githubLink = document.createElement('a');
                githubLink.href = project.github_url;
                githubLink.target = '_blank';
                githubLink.rel = 'noopener noreferrer';
                githubLink.className = 'inline-flex items-center px-4 py-2 bg-dark-600 hover:bg-dark-500 text-white rounded-lg text-sm font-medium transition-all duration-300';
                githubLink.setAttribute('aria-label', 'View on GitHub');
                
                const githubIcon = document.createElement('i');
                githubIcon.className = 'fab fa-github mr-2';
                githubLink.appendChild(githubIcon);
                githubLink.appendChild(document.createTextNode('Code'));
                
                buttonsContainer.appendChild(githubLink);
              }
              
              // Live Demo button
              if (project.live_url) {
                const liveLink = document.createElement('a');
                liveLink.href = project.live_url;
                liveLink.target = '_blank';
                liveLink.rel = 'noopener noreferrer';
                liveLink.className = 'inline-flex items-center px-4 py-2 border border-primary-500/30 hover:border-primary-400/50 text-primary-400 rounded-lg text-sm font-medium transition-all duration-300 hover:bg-primary-500/10 hover:text-white';
                liveLink.setAttribute('aria-label', 'View live demo');
                
                const demoIcon = document.createElement('i');
                demoIcon.className = 'fas fa-external-link-alt mr-2';
                liveLink.appendChild(demoIcon);
                liveLink.appendChild(document.createTextNode('Live Demo'));
                
                buttonsContainer.appendChild(liveLink);
              }
              
              contentSection.appendChild(buttonsContainer);
              projectElement.appendChild(contentSection);
              projectsGrid.appendChild(projectElement);
            });
            
            projectsContainer.appendChild(projectsGrid);
          }
          
        } catch (error) {
          console.error('Failed to load projects:', error);
          if (loadingState) loadingState.classList.add('hidden');
          if (errorState) errorState.classList.remove('hidden');
        }
      }
      
      // Initial load
      loadProjects();
      
      // Set up retry button
      if (retryButton) {
        retryButton.addEventListener('click', loadProjects);
      }
    });
  </script>
</section>